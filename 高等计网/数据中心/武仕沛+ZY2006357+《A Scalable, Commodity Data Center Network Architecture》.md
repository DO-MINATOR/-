### 摘要

传统的数据中心网络架构采用树形拓扑，即使是采用高端的网络设备，顶层的设备都难以支撑网络边缘的数据总流量。面临着流量的非均匀化，软件协议设计的复杂性，使得成本大大提高。

作者展示了利用传统的网络交换设备并设计良好的架构可以换来高性能的服务，并且完全兼容现有网络协议和硬件接口。

### 传统认知

- 数据中心有成千上万的计算机构成，且带宽需求量巨大。
- 网络架构由路由和交换机组成树形结构，越来越多的高端设备的加入使得网络层次结构越发的明晰。
- 即使采用最高端的网络设备也只能支撑整个网络50%的带宽
- 流量大小的不一致性导致传统的算法很难适配数据中心，或者说需要设计很复杂的算法

### 新的数据中心应当预备的特点

- 大规模使用传统的网络设备就可以支撑大量的网络流量
- 采取新型架构可以以较低的成本换取高性能
- 完全向后兼容，不必更改现有网络设备和协议

### 关键字

网络设计架构、等值路由

### 问题分析

商用集群的出现使得任何一个组织都可以轻松实现大量的计算和PB级的存储。关键瓶颈在于节点之间的通讯，web查询、云计算、并行计算。

解决方案，利用新型互联硬件和软件，如infiniBand，Myrinet，扩展性较好，但实现成本高，且无法兼容现有网络协议。二是采用传统网络设别和协议，但随着网络节点数量的增加，管理成本、利用率、可扩展性效果都变得极差。大部分都采用第二种设计模式，并升级设备性能，但网络整体性能仍受限于中心节点的处理能力。

### 设计目标

- 可伸缩性，且任意加入主机都能够以本地连接处的全部带宽与其它主机进行通信。
- 廉价性，能够利用传统设备集群实现大规模部署，
- 兼容性：新的架构能够向后兼容网络接口和软件协议。

作者展望了利用传统网络，结合胖树架构，可以轻松实现大规模网络互联，即使出现更高端的网络设备，他们设计的架构也具有同等性能，且更加廉价。

### 背景

#### 拓扑结构

![image-20201117095629548](https://imagebag.oss-cn-chengdu.aliyuncs.com/img/image-20201117095629548.png)

三层网络架构包括核心层、汇聚层、边缘层，相比二层架构，可以提供更多的主机互联。

- 边缘层：汇聚边缘流量，向上传输。
- 汇聚层：同上
- 

#### 超额订阅

1：1代表所有主机都能够以本链路的全部带宽与其他主机进行通信。5：1，代表只有20%的主机可以实现。

#### 等价路由

ECMP支持任意主机间的通信可以采用不同的路径进行传输，采用ECMP可以使得有更多的节点实现全速率通信。然而，ECMP基于静态负载划分， 没有动态的支持，使得超额订阅增加，此外，ECMP提供的等价路由数较少，无法实现数据中心网络所需要的数量，随着路由数的增多，路由表项的个数也将成倍的增加。

#### 花费

不光考虑部署架构时带来的花费，还应当考虑采用不同超额订阅比时，网络所需要的额外支撑。可见，当超额订阅比为1：1时，网络总体成本最高。采用3：1时效益成本比最高，但意味着平均每个主机只能利用1/3的链路带宽。

![image-20201117101955345](https://imagebag.oss-cn-chengdu.aliyuncs.com/img/image-20201117101955345.png)

另外，使用传统的路由算法无法充分的利用胖树架构的特性，导致单位传输成本上升。

基于胖树架构，需要考虑传输瓶颈，布线复杂性。

### 架构设计

包含：路由表结构的设计、ip地址的划分。两级路由查找，路由算法的实现，同时提出了优化等价路由的流分类和流调度技术。实现目的是达到多路径等价路由的充分利用，以及超额订阅比，

难点：如何实现路由算法能够将网络流量均匀的分配到不同路径上，传统的OSPF基于跳数选择“最短路径”，然而基于K-ary的胖树结构本来拥有k/2个最短路径，但却只选择了一个，网络流被集中到一个端口上，无法利用等价路由和改善超额订阅。而OSPF-ECMP改进版则会导致路由表项数量的增加。最终提出基于两级路由查找的算法来充分利用网络带宽。

#### 地址分配

汇聚层中第二个byte代表pod数，第三个byte代表哪一个交换机，边缘层，根据所连接的交换机，其第四个byte依次+1。

![image-20201117105604200](https://imagebag.oss-cn-chengdu.aliyuncs.com/img/image-20201117105604200.png)

#### 两级路由查找

根据改进的路由表结构和地址划分，使得路由转发的路径更均匀。两级路由表的设计需要在每一个路由表项中插入一个额外的指针指向更小层次的路由表项。

使用CAM内容寻址内存，进行并行搜索，查找引擎通过三元凸轮TCAM，但CAM存储密度极低，且能耗较高。不过该体系结构中，内容表可以在规模相对适中的TCAM中实现。路由表包含两层结构，一层是后缀表，决定北向路由，一层是前缀表，决定南向路由。