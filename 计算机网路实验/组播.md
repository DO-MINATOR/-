#### 组播概念

组播基于UDP，不可靠，报文重复、不按序到达...

PC：组播应用传播者，需要支持IGMP，运行组播程序

交换机：实现二层组播转发

路由器：核心，支持IGMP，组播路由

pc与路由器：组成员关系协议IGMP	路由器间：组播路由协议PIM

#### 协议

224.0.0.0——224.0.0.255为网络协议预留，不会进行转发

224.0.1.0——238.255.255.255为用户组播地址

239.0.0.0——239.255.255.255本地组播管理地址

IP到MAC组播地址的映射由于5位缺失导致映射不唯一，因此链路层会收到多个不相关的报文，IP层必须会过滤

#### IGMP

主机与路由器间的组播查询与报告协议。多台路由器中选举出一个IGMP查询器，其余路由器只需接收IGMP报告报文即可。IGMP查询器选举IP最小的路由器为查询器，其他非查询器设置一个定时器，用于检验查询器是否还存活

### PIM-DM（构造SPT）

#### 逆向路径转发

在多个PIM路由器中，如果不加以限制组播报文的传播，则报文有可能会被无限制转发，通过检查组播报文的源地址是否在该入口地址，就可以避免此问题，即RPF

#### 扩散

当一个组播报文传递到根路由器时，从根路由器向外扩散，并且每当通过RPF检查时，就会在该路由器中建立相应的组播路由转发表，如果走到边缘路由器上时，就通过检查IGMP表项，检查该子网段中是否含有该组播用户，如果没有，则向上游发送剪枝报文，然后上游路由器的相应转发接口设置一个pruning定时器，定时期间内不会转发，超时后再次转发，如果又收到剪枝，则又变为pruning状态，周而复始（扩散-剪枝-扩散-剪枝）

#### 嫁接与应答

如果定时器时间内，下游出现组播接收者，则该路由器向上游发送嫁接请求报文（craft message），上游同意后，回复craft ack message。

#### 断言

![image-20201011160514949](https://imagebag.oss-cn-chengdu.aliyuncs.com/img/image-20201011160514949.png)

A、B有相同的下游组播转发项，为避免转发相同的组播报文，他俩要进行断言，通过比较组播源地址的优先级、度量值、ip地址（大者优先）来决定谁来转发该组播报文

### PIM-SM（构造RPT）

dm协议适合小型且组播密集的网络。而sm协议适合大型且稀疏的网络。核心是构造一个RP（核心节点），并以此为核心构造RPT

