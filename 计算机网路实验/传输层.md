TCP是端到端、面向连接、可靠的传输层协议

#### 连接建立：三次握手

![image-20201018170119495](https://imagebag.oss-cn-chengdu.aliyuncs.com/img/image-20201018170119495.png)

序号的确认，协商MSS，确保数据能够转入TCP报文。MSS为报文段数据字段的最大长度，选取两方中较小的那一个，并应用于数据传输阶段，值为1460字节。

MSS＝以太网最大帧长度－以太网帧头和帧尾（18）－IP首部固定长度（20）－TCP首部固定长度（20）＝1518－18－20－20＝1460

第三次确认报文不消耗序号

#### 数据传输

根据序号字段、长度字段、确认号字段实现全双工通信

#### 连接释放：四次握手

![image-20201022163143525](https://imagebag.oss-cn-chengdu.aliyuncs.com/img/image-20201022163143525.png)

#### 滑动窗口技术

接收端的rwnd、拥塞窗口cwnd，发送端窗口大小取二者最小值

#### 糊涂窗口综合征

接收端如果处理较慢，每次都向发送端通告一个较小的接收窗口，则导致传输效率下降。由此引出Nagle算法

#### Nagle

发送端每次尽量发送较大的数据包，每当发送方填入发送缓存数据时，检查缓存剩余大小是否还有一般或一个MSS，有则不发送，再进行发送缓存填充，同样接收方也要等到接收缓存大小达到1个MSS时才通告接受窗口。

#### 慢启动

一开始cwnd设置为2*MSS，此后每收到一个确认报文后，cwnd增加一个MSS。

#### 拥塞避免

cwnd超过一定阈值ssthresh后，就需要收到cwnd个确认后，cwnd才能增加一个MSS。

#### 拥塞处理

如果未按时收到ACK或重复收到ACK，则更新ssthresh=max（cwnd/2，2*MSS）和cwnd=1

#### 超时与重传

每当定时器超时时，应当重传数据，公式为新的重传时间=y*旧的重传时间，y一般为2

#### 窗口探查

接收端缓存满时，向发送端发送0窗口通告，如果后期的非0窗口通告丢包，则有可能发生死锁，因此发送方定期查询接收方的接受窗口，看是否已经增大。

#### 快重传

针对超时重传，如果连续收到3个重复ACK，则不必等待定时器，直接重传丢失的报文。

#### 快恢复

针对拥塞处理，如果连续收到3个以上重复ACK，则更新ssthresh=max（cwnd/2，2*MSS）和cwnd=min（cwnd，cwnd_r-pointer+3+重传的报文数），当接收到新的ACK后，cwnd恢复到ssthresh，之后直接进入拥塞避免

